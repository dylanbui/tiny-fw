<?php

class Home_UserController extends BaseController
{

	public function __construct()
	{
		parent::__construct();
	}

	public function indexAction() 
	{
	    return $this->forward('home/user/list');
	}	
	
	public function listAction() 
	{
		$this->oView->title = 'PHP MVC Framework';
		
		$objUser = new Base_User();
		
		$rsUsers = $objUser->getAllUser();
		
		$this->oView->rsUsers = $rsUsers;		
		
		$this->renderView('home/user/list');
	}
	
	public function addAction()
	{
		$this->oView->box_title = "Add New User";
		$this->oView->link_url = site_url('home/user/add');		
		$this->oView->cancel_url = site_url('home/user/list');
		
		$objGroup = new Base_Group();
		$rsGroups = $objGroup->getRowset();
		$this->oView->rsGroups = $rsGroups;

		if ($this->oParams->isPost()) 
		{
			// TODO : Check validate
			$group_id = $this->oParams->varPost("group_id",array());
			$group_id = implode(",", $group_id);
			
			$data = array(
				"username" => $this->oParams->varPost("username",""),					
				"display_name" => $this->oParams->varPost("display_name",""),		
				"email" => $this->oParams->varPost("email",""),
				"password" => encryption($this->oParams->varPost("pw","")),
				"group_id" => $group_id,
				"activated" => $this->oParams->varPost("activated",0)					
			);
			
			// TODO : Notify save successfully
			$oUser = new Base_User();
			$oUser->insert($data);			
		}
		
		$this->renderView('home/user/add');
	}
	
	public function editAction($user_id)
	{
		$this->oView->box_title = "Update User";
		$this->oView->link_url = site_url('home/user/edit/'.$user_id);
		$this->oView->cancel_url = site_url('home/user/list');
	
		$objGroup = new Base_Group();
		$rsGroups = $objGroup->getRowset();
		$this->oView->rsGroups = $rsGroups;
		
		$oUser = new Base_User();
		
		if ($this->oParams->isPost())
		{
			// TODO : Check validate
			$group_id = $this->oParams->varPost("group_id",array());
			$group_id = implode(",", $group_id);
			
			$data = array(
				"username" => $this->oParams->varPost("username",""),					
				"display_name" => $this->oParams->varPost("display_name",""),
				"email" => $this->oParams->varPost("email",""),
				"group_id" => $group_id,
				"activated" => $this->oParams->varPost("activated",0)
			);			
			
			$reset_password = $this->oParams->varPost('reset_password',NULL);
			if ($reset_password != NULL)
			{
				// TODO : Check validate password
				$data['password'] = encryption($this->oParams->varPost("pw",""));
			}
				
			// TODO : Notify save successfully
			$oUser->update($user_id,$data);
			
			$currentUser = $this->oAuth->currentUser();
			
			if ($reset_password != NULL || $data['username'] != $currentUser['username'])
			{
				// Reseted pw or change username
				redirect("");
			}			
			
			
		}		
		
		$rowUser = $oUser->get($user_id);
		
		$this->oView->rowUser = $rowUser;
		$this->oView->arrGroupIds = explode(",",$rowUser['group_id']);
		
		$this->renderView('home/user/edit');
	}
	
	public function deleteAction($user_id)
	{
		// TODO : Check validate $user_id
		$oUser = new Base_User();
		$oUser->delete($user_id);
		redirect("home/user/list");
	}
	
	public function activateAction($user_id)
	{
		// TODO : Check validate $user_id
		$oUser = new Base_User();
		$rowUser = $oUser->get($user_id);
		
		$data = array(
			"activated" => ($rowUser['activated'] == 0 ? 1 : 0)
		);
		
		// TODO : Notify save successfully
		$oUser->update($user_id,$data);		
		redirect("home/user/list");	
	}	

}
